name: clang-format (auto-format)

on:
  push:
    branches-ignore: ["main"]
    paths:
      - "app/**"
      - "include/**"
      - "src/**"
      - ".clang-format"
      - ".clang-format-ignore"
      - ".github/workflows/clang-format.yml"

permissions:
  contents: write

concurrency:
  group: clang-format-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    container: ubuntu:25.10

    strategy:
      matrix:
        config:
          - preset: x64-linux-clang-debug
            compiler: clang
            clang-format: true

    env:
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/.vcpkg_cache
      VCPKG_BINARY_SOURCES: "default"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: vcpkg-cache-directory
        shell: bash
        run: mkdir -p "$VCPKG_DEFAULT_BINARY_CACHE"

      - name: vcpkg-cache-restore
        uses: actions/cache@v4
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: vcpkg-${{ matrix.config.compiler }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ matrix.config.compiler }}-

      - name: install-tools
        shell: bash
        run: |
          apt update -y
          apt upgrade -y
          apt install -y curl tar git zip unzip make autoconf libtool ninja-build cmake
          apt install -y clang-20 clang-format-20
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-20 200
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-20 200
          update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-20 200

      - name: install-raylib-dependencies
        run: |
          apt install -y libxinerama-dev libxcursor-dev xorg-dev libglu1-mesa-dev pkg-config libgl1-mesa-dev libx11-dev libxrandr-dev

      - name: cmake-configure
        run: cmake --preset ${{ matrix.config.preset }}

      - name: clang-format
        if: ${{ matrix.config.clang-format }}
        run: cmake --build --preset ${{ matrix.config.preset }} --target clang-format

      - name: commit-and-push
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No formatting changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore: clang-format"
          git push origin "HEAD:${{ github.ref_name }}"
