name: clang-format (auto-format)

on:
  push:
    branches-ignore: ["main"]
    paths:
      - "**/*.cpp"
      - "**/*.h"
      - "**/*.ixx"
      - ".clang-format"
      - ".clang-format-ignore"

permissions:
  contents: write

concurrency:
  group: clang-format-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format:
    # Prevent infinite loops from the botâ€™s own formatting commit
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    container: ubuntu:25.10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: install-tools
        shell: bash
        run: |
          set -euo pipefail
          apt-get update -y
          apt-get install -y git

      - name: run-clang-format-on-all-files
        shell: bash
        run: |
          set -euo pipefail

          echo "Formatting ALL tracked source files on this branch..."
          git ls-files -z -- \
            '*.cpp' '*.h' '*.ixx' \
            | xargs -0 -r clang-format -i

      - name: commit-and-push
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No formatting changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore: clang-format"

          # Push back to the same branch even if checkout is detached
          git push origin "HEAD:${{ github.ref_name }}"
